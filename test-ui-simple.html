<!DOCTYPE html>
<html>
<head>
    <title>Simple UI Test</title>
</head>
<body>
    <h1>Test Analysis System</h1>
    <p>Open browser console to see results</p>
    
    <button onclick="testAnalysis()">Test Strategic Markets Query</button>
    <button onclick="testAll()">Test All Queries</button>
    
    <div id="results"></div>

    <script>
        async function testAnalysis() {
            console.log('=== Testing Strategic Markets Query ===');
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<h3>Testing...</h3>';
            
            try {
                // Load and test the analysis engine modules
                const modules = await Promise.all([
                    import('/lib/analysis/AnalysisEngine.js'),
                    import('/lib/analysis/ConfigurationManager.js'),
                    import('/lib/analysis/CachedEndpointRouter.js'),
                    import('/lib/analysis/DataProcessor.js')
                ]);
                
                console.log('✅ Modules loaded successfully');
                resultsDiv.innerHTML += '<p>✅ Modules loaded</p>';
                
                // Create instances
                const { AnalysisEngine } = modules[0];
                const { ConfigurationManager } = modules[1];
                const { CachedEndpointRouter } = modules[2];
                const { DataProcessor } = modules[3];
                
                const configManager = new ConfigurationManager();
                const endpointRouter = new CachedEndpointRouter(configManager);
                const dataProcessor = new DataProcessor(configManager);
                const engine = new AnalysisEngine();
                
                console.log('✅ Components created');
                resultsDiv.innerHTML += '<p>✅ Components created</p>';
                
                // Test endpoint selection
                const query = "Show me the top strategic markets for Nike expansion";
                const endpoint = await endpointRouter.selectEndpoint(query);
                console.log('Selected endpoint:', endpoint);
                resultsDiv.innerHTML += `<p>Selected endpoint: ${endpoint}</p>`;
                
                // Test data loading
                const rawData = await endpointRouter.callEndpoint(endpoint, query);
                console.log('Raw data loaded:', rawData.results?.length || 0, 'records');
                resultsDiv.innerHTML += `<p>Raw data: ${rawData.results?.length || 0} records</p>`;
                
                // Test data processing
                const processedData = dataProcessor.processResults(rawData, endpoint);
                console.log('Processed data:', processedData.records?.length || 0, 'records');
                resultsDiv.innerHTML += `<p>Processed data: ${processedData.records?.length || 0} records</p>`;
                
                if (processedData.records?.length > 0) {
                    resultsDiv.innerHTML += '<h4>Top 3 Areas:</h4>';
                    const top3 = processedData.records.slice(0, 3);
                    top3.forEach((record, idx) => {
                        resultsDiv.innerHTML += `<p>${idx + 1}. ${record.area_name}: ${record.value.toFixed(2)}</p>`;
                    });
                }
                
                // Full engine test
                console.log('=== Testing full engine ===');
                const fullResult = await engine.executeAnalysis(query);
                console.log('Full engine result:', fullResult);
                resultsDiv.innerHTML += `<h4>Full Engine Test:</h4>`;
                resultsDiv.innerHTML += `<p>Success: ${fullResult.success}</p>`;
                resultsDiv.innerHTML += `<p>Records: ${fullResult.data?.records?.length || 0}</p>`;
                
            } catch (error) {
                console.error('Test failed:', error);
                resultsDiv.innerHTML += `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }
        
        async function testAll() {
            const queries = [
                "Show me the top strategic markets for Nike expansion",
                "analyze nike markets",
                "competitive analysis of nike and adidas",
                "identify spatial clusters for nike"
            ];
            
            for (const query of queries) {
                console.log(`\n=== Testing: "${query}" ===`);
                await testSingleQuery(query);
            }
        }
        
        async function testSingleQuery(query) {
            try {
                const { AnalysisEngine } = await import('/lib/analysis/AnalysisEngine.js');
                const engine = new AnalysisEngine();
                const result = await engine.executeAnalysis(query);
                
                console.log(`✅ ${query}:`, {
                    success: result.success,
                    endpoint: result.endpoint,
                    records: result.data?.records?.length || 0,
                    error: result.error
                });
                
            } catch (error) {
                console.error(`❌ ${query}:`, error.message);
            }
        }
    </script>
</body>
</html>