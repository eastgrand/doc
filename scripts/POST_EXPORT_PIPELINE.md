# Post-Export Data Generation Pipeline

After running `export-optimized-datasets.py`, two additional datasets need to be generated using post-processing scripts. These datasets are derived from the microservice exports and add specialized scoring algorithms.

## Overview

**customer-profile.json** and **strategic-analysis.json** are NOT direct microservice endpoints. They are generated by post-processing scripts that apply additional scoring algorithms to microservice data.

## Pipeline Steps

### 1. Run Main Export Script

First, export all microservice endpoints with SHAP optimization:

```bash
cd /Users/voldeck/code/mpiq-ai-chat/scripts
python3 export-optimized-datasets.py
```

This exports 16 actual microservice endpoints with location-specific SHAP values.

### 2. Generate Strategic Analysis Dataset

**Requires**: `correlation-analysis.json` (exported in step 1)

#### Step 2a: Add Strategic Value Scores
```bash
cd /Users/voldeck/code/mpiq-ai-chat/scripts/scoring
node strategic-value-scores.js
```

**What it does:**
- Reads correlation-analysis data 
- Calculates strategic_value_score using formula:
  - Market Opportunity (35%) - Demographics + Market fundamentals
  - Competitive Position (30%) - Competitive advantage + Brand positioning  
  - Data Reliability (20%) - Correlation strength + Data consistency
  - Market Scale (15%) - Population size + Economic scale

#### Step 2b: Create Strategic Analysis File
```bash
cd /Users/voldeck/code/mpiq-ai-chat/scripts
node create-strategic-analysis.js
```

**What it does:**
- Takes correlation data with strategic_value_score
- Formats it as strategic-analysis.json with proper metadata
- Creates microservice-compatible structure

**Output**: `/Users/voldeck/code/mpiq-ai-chat/public/data/endpoints/strategic-analysis.json`

### 3. Generate Customer Profile Dataset

**Requires**: `strategic-analysis.json` (generated in step 2)

```bash
cd /Users/voldeck/code/mpiq-ai-chat/scripts/scoring
node generate-customer-profile-scores.js
```

**What it does:**
- Reads strategic-analysis.json as input
- Calculates customer profile scores based on:
  - Demographic alignment (age, income, household characteristics)
  - Lifestyle indicators (wealth, activity patterns)  
  - Behavioral patterns (Nike affinity, purchase propensity)
  - Market context (size, stability, growth potential)
- Generates persona classifications
- Outputs flat array format (different from microservice structure)

**Output**: `/Users/voldeck/code/mpiq-ai-chat/public/data/endpoints/customer-profile.json`

## Complete Pipeline Command Sequence

```bash
# 1. Export all microservice endpoints with SHAP optimization
cd /Users/voldeck/code/mpiq-ai-chat/scripts
python3 export-optimized-datasets.py

# 2. Generate strategic analysis dataset
cd /Users/voldeck/code/mpiq-ai-chat/scripts/scoring
node strategic-value-scores.js
cd ..
node create-strategic-analysis.js

# 3. Generate customer profile dataset  
cd scoring
node generate-customer-profile-scores.js
```

## Key Files

### Input Files (from microservice export):
- `correlation-analysis.json` - Base data for strategic analysis

### Processing Scripts:
- `scripts/scoring/strategic-value-scores.js` - Adds strategic scoring
- `scripts/create-strategic-analysis.js` - Creates strategic analysis format
- `scripts/scoring/generate-customer-profile-scores.js` - Creates customer profiles

### Output Files:
- `strategic-analysis.json` - Strategic market analysis with scoring methodology
- `customer-profile.json` - Customer profiling with persona classifications

## Data Flow

```
correlation-analysis.json (microservice)
    ↓
strategic-value-scores.js (adds strategic_value_score) 
    ↓
create-strategic-analysis.js (formats with metadata)
    ↓
strategic-analysis.json
    ↓
generate-customer-profile-scores.js (customer profiling)
    ↓
customer-profile.json
```

## Notes

- **Order matters**: Strategic analysis must be generated before customer profiles
- **SHAP optimization**: All source data now includes location-specific SHAP values
- **File sizes**: 
  - strategic-analysis.json: ~295k lines (~10MB)
  - customer-profile.json: ~339k lines (~11MB)
- **Dependency**: Customer profiles depend on strategic analysis data, not direct microservice data

## Troubleshooting

If strategic-value-scores.js fails:
- Ensure correlation-analysis.json exists and has proper structure
- Check that microservice export completed successfully

If generate-customer-profile-scores.js fails:
- Ensure strategic-analysis.json exists
- Verify strategic_value_score field is present in the data

## Integration with Main Application

Both generated files are used by the main mpiq-ai-chat application:
- `strategic-analysis.json` - For strategic market insights and expansion planning
- `customer-profile.json` - For customer segmentation and persona analysis

The post-processing ensures these specialized analyses benefit from the new SHAP-optimized location-specific calculations while maintaining the existing business logic.