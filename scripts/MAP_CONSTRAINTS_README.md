# Dynamic Map Constraints System

## Overview

This system dynamically constrains the map view to the project's data extents, preventing users from panning outside the relevant geographic area while preserving full zoom functionality.

## How It Works

### 1. **Extent Calculation**
- Queries the first polygon layer from `config/layers.ts`
- Fetches the full extent from the ArcGIS Feature Service
- Adds a 10% buffer around the data extent for breathing room

### 2. **Constraint Generation**
- Creates `config/mapConstraints.ts` with TypeScript definitions
- Includes both the buffered constraints and original data extent
- Provides helper functions for easy integration

### 3. **Map Integration**
- `MapClient.tsx` automatically applies constraints on map creation
- **Preserves original map center** (Jacksonville, FL) - does not change initial view
- Uses Web Mercator projection (EPSG:102100) for accurate extent calculation
- Preserves all zoom levels while restricting panning only

## Usage

### Generate Constraints
After updating layer configurations (typically after running the automation pipeline):

```bash
# Using npm script (recommended)
npm run generate-map-constraints

# Or directly
node scripts/generate-map-constraints.js
```

### Manual Integration (already done in MapClient.tsx)
```typescript
import { applyMapConstraints, zoomToDataExtent } from '@/config/mapConstraints';

// Apply constraints to a MapView
applyMapConstraints(mapView);

// Zoom to data extent
zoomToDataExtent(mapView);
```

## Generated Files

### `config/mapConstraints.ts`
- **MAP_CONSTRAINTS**: Buffered extent for map constraints
- **DATA_EXTENT**: Original data extent for reference
- **applyMapConstraints()**: Helper function to apply constraints
- **zoomToDataExtent()**: Helper function to zoom to data

## Features

‚úÖ **Dynamic Generation**: Based on actual project data extents
‚úÖ **Smart Buffering**: 10% buffer prevents edge cases
‚úÖ **Zoom Preservation**: Full zoom in/out capability maintained
‚úÖ **Center Preservation**: Keeps original map center (Jacksonville, FL)
‚úÖ **Panning Constraints**: Only restricts panning boundaries
‚úÖ **Rotation Disabled**: Prevents accidental map rotation
‚úÖ **TypeScript Support**: Full type definitions included
‚úÖ **Automation Integration**: Alerts when constraints need updating
‚úÖ **Easy Regeneration**: Simple npm script for updates

## Automation Integration

The automation pipeline (`scripts/automation/run_complete_automation.py`) automatically alerts you to regenerate map constraints after updating layer configurations:

```
üó∫Ô∏è  IMPORTANT: UPDATE MAP CONSTRAINTS
==================================================
‚ö†Ô∏è  The layer configuration has been updated with new data.
   Run either of the following commands to update map constraints:

   npm run generate-map-constraints
   OR
   node scripts/generate-map-constraints.js

   This will:
   ‚Ä¢ Fetch the extent from your polygon layers
   ‚Ä¢ Generate dynamic map constraints
   ‚Ä¢ Prevent users from panning outside project area
   ‚Ä¢ Preserve full zoom functionality
==================================================
```

## Technical Details

### Spatial Reference
- Uses Web Mercator (EPSG:102100) for accurate distance calculations
- Automatically converts between coordinate systems as needed

### Performance
- Minimal impact on map initialization
- One-time constraint application
- No ongoing performance overhead

### Compatibility
- Works with all ArcGIS polygon feature services
- Compatible with ArcGIS Maps SDK for JavaScript
- Supports both development and production environments

## Troubleshooting

### Common Issues

**Script fails to find layer URL:**
- Ensure `config/layers.ts` exists and contains feature service URLs
- Check that layers have been generated by the automation pipeline

**Network errors:**
- Verify the ArcGIS feature service is accessible
- Check network connectivity and firewall settings

**Map doesn't respect constraints:**
- Ensure `config/mapConstraints.ts` is imported correctly
- Check browser console for constraint application logs
- Verify MapView is ready before applying constraints

### Debug Logging
The system includes comprehensive logging:
- Extent calculation details
- Constraint application confirmation
- Error messages with troubleshooting hints

## Example Output

```javascript
// Generated constraints (example)
export const MAP_CONSTRAINTS = {
  geometry: {
    xmin: -9840080,  // Buffered extent
    ymin: 2735437,
    xmax: -8824400,
    ymax: 3714457,
    spatialReference: { wkid: 102100 }
  },
  rotationEnabled: false
};

export const DATA_EXTENT = {
  xmin: -9755440,  // Original extent
  ymin: 2817022,
  xmax: -8909040,
  ymax: 3632872,
  spatialReference: { wkid: 102100 }
};
```

## Integration Status

‚úÖ **Script Created**: `scripts/generate-map-constraints.js`
‚úÖ **MapClient Updated**: Automatic constraint application
‚úÖ **NPM Script Added**: `npm run generate-map-constraints`
‚úÖ **Automation Alert**: Reminds to update constraints
‚úÖ **Documentation**: Complete usage instructions

The dynamic map constraints system is fully integrated and ready for production use!